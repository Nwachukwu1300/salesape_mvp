// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String
  refreshToken String?
  businesses Business[]
  teamMemberships TeamMember[]
  conversationSessions ConversationSession[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Business {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  url         String
  description String?
  logo        String?
  phone       String?
  address     String?
  hours       Json?  // { mon_fri: "7am - 8pm", sat_sun: "8am - 9pm" } or custom
  views       Int     @default(0)  // Page view counter
  publishedUrl String?
  analysis    Json?
  generatedConfig Json?
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  slug        String?   @unique
  // Website Generation Engine fields
  templateId       String?
  websiteConfig    Json?
  generationStatus String   @default("idle") // idle, queued, processing, completed, failed
  generationStep   String?  // Current step: scraping, analyzing, selecting_template, generating_config, enriching_images
  imageAssets      Json?    // { hero: string, gallery: string[] }
  // Encrypted credentials for third-party integrations
  googleCalendarTokens String?  // Encrypted JSON: {accessToken, refreshToken}
  outlookCalendarTokens String?  // Encrypted JSON: {accessToken, refreshToken}
  apiKeysEncrypted String?  // Encrypted JSON: {openai, other}
  leads       Lead[]
  bookings    Booking[]
  calendarBookings CalendarBooking[]
  availableSlots AvailableSlot[]
  emailSequences EmailSequence[]
  analytics   Analytics[]
  abTests     ABTest[]
  testimonials Testimonial[]
  team        Team?
  subscription Subscription?
  payments    Payment[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Lead {
  id        String    @id @default(cuid())
  businessId String
  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name      String
  email     String
  company   String?
  message   String?
  status    String    @default("new")  // new, contacted, converted, declined
  source    String?   // web, instagram, direct
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Booking {
  id        String    @id @default(cuid())
  businessId String
  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name      String
  email     String
  date      String
  time      String
  status    String    @default("confirmed")
  createdAt DateTime  @default(now())

  @@unique([businessId, date, time])
}

model Testimonial {
  id        String    @id @default(cuid())
  businessId String
  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  clientName String
  clientTitle String?  // "CEO at Acme Co", "Happy Customer", etc.
  content   String     // The testimonial text
  rating    Int?       // 1-5 stars (optional)
  imageUrl  String?    // Avatar/photo of client (optional)
  isPublished Boolean  @default(true)
  order     Int        @default(0)  // Display order
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model AvailableSlot {
  id        String    @id @default(cuid())
  businessId String
  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  dayOfWeek Int       // 0-6 (Sunday-Saturday)
  startTime String    // HH:mm format
  endTime   String    // HH:mm format
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model EmailSequence {
  id        String    @id @default(cuid())
  businessId String
  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name      String    // "new_lead", "booking_reminder", etc.
  subject   String
  body      String    // HTML email body
  delayMinutes Int   @default(0)  // delay before sending
  triggerEvent String // "lead_created", "booking_created", "lead_contacted"
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Analytics {
  id        String    @id @default(cuid())
  businessId String
  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  eventType String    // "lead_created", "booking_created", "website_viewed", "form_submitted"
  eventData Json?
  source    String?   // web, instagram, direct, sms
  createdAt DateTime  @default(now())
}

model Team {
  id        String    @id @default(cuid())
  businessId String    @unique
  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name      String
  members   TeamMember[]
  leadRoutingRules LeadRoutingRule[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model TeamMember {
  id        String    @id @default(cuid())
  teamId    String
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String    @default("member")  // admin, manager, member
  email     String
  status    String    @default("invited")  // invited, active
  invitedAt DateTime  @default(now())
  joinedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([teamId, email])
}

model LeadRoutingRule {
  id        String    @id @default(cuid())
  teamId    String
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  assignTo  String    // email of team member
  service   String?   // specific service type (null = all services)
  leadSource String?  // web, instagram, direct, sms (null = all sources)
  priority  Int       @default(0)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Subscription {
  id        String    @id @default(cuid())
  businessId String    @unique
  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  planId    String    // basic, pro, enterprise
  status    String    @default("active")  // active, canceled, expired
  stripeCustomerId String?
  stripeSubscriptionId String?
  currentPeriodStart DateTime
  currentPeriodEnd DateTime
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Payment {
  id        String    @id @default(cuid())
  businessId String
  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  stripePaymentId String?
  amount    Int       // amount in cents
  currency  String    @default("usd")
  status    String    @default("pending")  // pending, succeeded, failed
  description String?
  invoiceUrl String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model ABTest {
  id        String    @id @default(cuid())
  businessId String
  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name      String
  variantA  Json      // {headline, cta, image, color}
  variantB  Json      // {headline, cta, image, color}
  status    String    @default("running")  // running, completed, paused
  winner    String?   // a, b, or null if no winner
  confidence Int      @default(0)  // 0-100
  metricsA  Json?     // {views, clicks, conversions, ctr, conversionRate}
  metricsB  Json?     // {views, clicks, conversions, ctr, conversionRate}
  startDate DateTime  @default(now())
  endDate   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model SeoAudit {
  id        String   @id @default(cuid())
  userId    String?
  businessId String?
  url       String
  performance Int
  seo        Int
  accessibility Int
  bestPractices Int
  issues     Json?
  recommendations Json?
  raw        Json?
  createdAt  DateTime @default(now())
}

model AuditUsage {
  id        String   @id @default(cuid())
  userId    String
  year      Int
  month     Int
  count     Int      @default(0)
  createdAt DateTime @default(now())

  @@unique([userId, year, month])
}

model CalendarBooking {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  leadId     String?
  provider   String   // google | calendly
  startTime  DateTime
  endTime    DateTime
  createdAt  DateTime @default(now())
}

model PublicSeoAudit {
  id        String   @id @default(cuid())
  url       String
  email     String   // Email of person requesting audit
  ipAddress String   // IP address for rate limiting (1 per week)
  performance Int
  seo        Int
  mobile     Int
  overallScore Int
  issues     Json?
  recommendations Json?
  raw        Json?
  createdAt  DateTime @default(now())

  @@index([ipAddress, createdAt])
  @@index([email, createdAt])
}

model ConversationSession {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Json     // Array of { role: "user" | "assistant", content: string, timestamp: DateTime }
  extracted Json?    // Extracted BusinessUnderstanding that matches schema
  status    String   @default("active")  // active, completed, abandoned
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

